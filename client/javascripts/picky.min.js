Array.prototype.index=function(a){for(var b=0,i=this.length;b<i;b++)if(this[b]==a)return b;return null};Array.prototype.include=function(a){return this.index(a)!==null};Array.prototype.remove=function(a){this.splice(a,1);return this};Array.prototype.compare=function(a){return this.join("")==a.join("")};Array.prototype.each=function(a){for(var b=0,i=this.length;b<i;b++)a(b,this[b]);return this};var dictionary={common:{join:{de:"und",fr:"et",it:"e",en:"and",ch:"und"},"with":{de:"mit",fr:"avec",it:"con",en:"with",ch:"mit"},of:{de:"von",fr:"de",it:"di",en:"of",ch:"vo"},to:{de:"bis",fr:"\u00e0",it:"alla",en:"to",ch:"bis"}},results:{addination:{more:{de:"Weitere Resultate",fr:"Autres r\u00e9sultats",it:"Altri risultati",en:"More results",ch:"Mee Resultaat"}},header:{de:"Ergebnisse",fr:"R\u00e9sultats",it:"Risultati",en:"Results",ch:"Erg\u00e4bnis"}}},t=function(a){for(var b=PickyI18n.locale||
"en",i=a.split(".").concat(b),f=dictionary,g=0,m=i.length;g<m;g++){f=f[i[g]];if(f==undefined){f="Translation missing: "+a+"."+b;break}}return f};function Allocation(a,b,i,f,g,m){var q=this;this.type=a;this.weight=b;this.count=i;this.combination=f;this.ids=g||[];this.entries=this.rendered=m||[];this.isType=function(s){return s==q.type}}function Allocations(a){this.allocations=[];for(var b=0,i=a.length;b<i;b++){var f=a[b];this.allocations.push(new Allocation(f[0],f[1],f[2],f[3],f[4],f[5]))}this.length=this.allocations.length;this.remove=function(g){this.allocations.splice(g,1)};this.each=function(g){this.allocations.each(g)}}
function PickyData(a){var b=a.total,i=a.duration,f=a.offset,g=new Allocations(a.allocations||[]);this.original_hash=a;this.total=b;this.duration=i;this.offset=f;this.allocations=g;this.renderedAmount=function(){var m=0;g.each(function(q,s){m+=s.rendered.length});return m};this.isEmpty=function(){return b==0}};var PickyView=function(a,b){var i=b.showResultsLimit||10,f=b.input,g=b.reset,m=b.button,q=b.counter,s=b.dashboard,x=b.moreSelector,w=b.results,y=b.noResults,r=new PickyAddination(this,w),n=new PickyAllocationsCloud(this,b),d=new PickyResultsRenderer(r,b),e=function(){g.fadeTo(166,1)},j=function(){n.hide();w.empty();y.hide()},p=function(h){f.val(h);g.fadeTo(166,0);o("empty");q.empty();j()},k=function(){return f.val()};this.text=k;var u=function(h){q.text(h);h>0&&h<=5&&q.fadeTo("fast",0.5).fadeTo("fast",
1)},c=function(h){if(h.isEmpty())return"none";if(h.total>i&&h.allocations.length>1)return"support";return"ok"},o=function(h){s.attr("class","dashboard "+h)};this.insert=function(h){f.val(h);f.select()};this.fullResultsCallback=function(h){o(c(h));if(h.isEmpty()){j();u(0);y.show();e()}else if(h.total>i&&h.allocations.length>1){j();e();n.show(h);u(h.total)}else if(h.offset==0){j();u(h.total);d.render(h);w.show();e();f.focus()}else{var v=$(x).position().top;r.remove();d.render(h);$("body").animate({scrollTop:v-
12},500)}};this.liveResultsCallback=function(h){o(c(h));u(h.total)};this.allocationChosen=function(h){h=h.data.query;a.insert(h);a.allocationChosen(h)};this.addinationClicked=function(h){a.addinationClicked(k(),h)};(function(){f.keyup(function(h){if(k()==""){p();a.searchTextCleared()}else{a.searchTextEntered(k(),h);e()}});q.click(function(){k()==""||a.searchButtonClicked(k())});m.click(function(){k()==""||a.searchButtonClicked(k())});g.click(function(){p("");a.clearButtonClicked();f.focus()})})();
f.focus()};var PickyBackend=function(a){var b=function(i,f,g){var m=g||{};m=$.extend({query:i},g);$.getJSON(a,m,function(q){f&&f(new PickyData(q))})};this.search=function(i,f,g,m){b(i,function(q){f&&f(m,q)},g)}},LiveBackend=function(a){var b=a.live||alert("A live backend path must be provided."),i=new PickyBackend(b);this.search=function(f,g,m,q){q=q||{};latestRequestTimestamp=new Date;q.live=latestRequestTimestamp;m=$.extend({ids:a.liveResults||0,offset:0},m);i.search(f,function(s,x){if(!s.live||s.live==latestRequestTimestamp)g&&
g(x)},m,q)}},FullBackend=function(a){var b=a.full||alert("A full backend path must be provided."),i=new PickyBackend(b);this.search=function(f,g,m,q){q=q||{};latestRequestTimestamp=new Date;q.full=latestRequestTimestamp;m=$.extend({ids:a.fullResults||20,offset:0},m);i.search(f,function(s,x){if(!s.full||s.full==latestRequestTimestamp)g&&g(x)},m,q)}};var PickyController=function(a){var b=new PickyView(this,a),i=a.backends,f=a.beforeInsert||function(){},g=a.before||function(){},m=a.success||function(){},q=a.after||function(){},s=a.liveRendered||false,x=a.liveSearchInterval||180,w,y=function(c){return(c=c&&c.match(/q=([^&]+)/))&&decodeURIComponent(c[1]).replace(/\+/g," ").replace(/#/g,"")||""};this.extractQuery=y;var r=function(){var c=window.History&&window.History.getState();return y(c&&c.url)};this.lastFullQuery=r;var n=function(c,o,h,v){o=g(o,
v)||o;w=[c,o,h,v];var z=o;if(z!=r()){z="?q="+escape(z).replace(/\*/g,"%2A");window.History&&window.History.getState()&&window.History.pushState&&window.History.pushState(null,null,z)}(c=i[c])&&c.search(o,h,v)};this.resend=function(){w&&n.apply(this,w)};var d=function(c,o){c=m(c,o)||c;b.fullResultsCallback(c);q(c,o)},e=function(c,o){clearInterval(p);n("full",c,d,o||{})};a=function(c,o){c=m(c,o)||c;b.liveResultsCallback(c);q(c,o)};var j=s?d:a,p,k=function(){var c=b.text();n("live",c,j,{});clearInterval(p)};
p=setInterval(k,x);clearInterval(p);var u=function(c,o,h){c=f(c)||c;b.insert(c);h&&e(c,o)};this.insert=u;this.clearButtonClicked=function(){clearInterval(p)};this.searchTextCleared=function(){clearInterval(p)};this.searchTextEntered=function(c,o){if($.inArray(o.keyCode,[0,8,13,32,46,48,49,50,51,52,53,54,55,56,57,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90])>-1)if(o.keyCode==13)e(c);else{clearInterval(p);p=setInterval(k,x)}};this.searchButtonClicked=function(c){e(c)};
this.allocationChosen=function(c){e(c)};this.addinationClicked=function(c,o){e(c,{offset:o.data.offset})};window.History&&window.History.Adapter.bind(window,"statechange",function(){var c=window.History.getState();(c=y(c.url))&&c!=(w.length>1&&w[1])&&u(c,{},true)})};var Localization={},PickyI18n={},PickyClient=function(a){PickyI18n.locale=$("html").attr("lang").split("-")[0]||"en";a.locale=a.locale||PickyI18n.locale;Localization.qualifiers=a.qualifiers||{};Localization.explanations=a.explanations||{};Localization.choices=a.choices||{};Localization.explanation_delimiters={de:"und",fr:"et",it:"e",en:"and",ch:"und"};var b=a.backends;if(b){b.live||alert("Both a full and live backend must be provided.");b.full||alert("Both a full and live backend must be provided.")}else a.backends=
{live:new LiveBackend(a),full:new FullBackend(a)};b=a.enclosingSelector||"#picky";a.input=$(a.inputSelector||b+" input.query");a.reset=$(a.resetSelector||b+" div.reset");a.button=$(a.buttonSelector||b+" input.search_button");a.counter=$(a.counterSelector||b+" div.status");a.dashboard=$(a.dashboardSelector||b+" .dashboard");a.results=$(a.resultsSelector||b+" div.results");a.noResults=$(a.noResultsSelector||b+" .no_results");a.moreSelector=a.moreSelector||b+" div.results div.addination:last";a.allocations=
$(a.allocationsSelector||b+" .allocations");a.shownAllocations=a.allocations.find(".shown");a.showMoreAllocations=a.allocations.find(".more");a.hiddenAllocations=a.allocations.find(".hidden");a.maxSuggestions=a.maxSuggestions||3;a.results=$(a.resultsSelector||b+" div.results");a.resultsDivider=a.resultsDivider||"";a.noAsterisks=a.noAsterisks||[];a.wrapResults=a.wrapResults||'<ol class="results"></ol>';var i=a.controller&&new a.controller(a)||new PickyController(a);var f=this.insert=function(g,m,q){i.insert(g,
m||{},q||true)};this.resend=i.resend;this.insertFromURL=function(g){if(g&&g!="")f(g);else(g=i.lastFullQuery())&&f(g)}};var PickyAddination=function(a,b){this.remove=function(){b.find(".addination").remove()};this.render=function(i){var f=i.total,g,m=i.renderedAmount();g=i.offset+m;m=g+m;i=i.total;if(i<m)m=i;g={offset:g,start:g+1,end:m};if(g.offset<f){f=$("<div class='addination'>"+t("results.addination.more")+"</div>");f.bind("click",{offset:g.offset},a.addinationClicked);return f}else return""}};var PickyResultsRenderer=function(a,b){var i=b.locale,f=b.results,g=b.resultsDivider,m=b.wrapResults,q=b.noAsterisks,s=function(n){var d=n[n.length-1];if(d===undefined)return[];n=n.slice(0,n.length-1);if(n==[])n=[n];if(!q.include(d[0]))if(d[1].match(/[^\*~]$/))d[1]+="*";n.push(d);return n};this.asteriskifyLastToken=s;var x=function(n){for(var d=Localization.explanations&&Localization.explanations[i]||{},e=[],j,p=0,k=n.length;p<k;p++){j=n[p];var u=j[0];u=d[u]||u;e.push([u,j[1]])}return e};this.explainCategory=
x;var w=function(n,d){return[n.replace(/([\w\s\u00c4\u00e4\u00d6\u00f6\u00dc\u00fc\u00e9\u00e8\u00e0\,]+)/,"<strong>$1</strong>"),d].join(" ")};this.strongify=w;var y=function(n,d){var e=Localization.explanation_delimiters[i],j="",p=[],k=[];x(s(d)).each(function(u,c){var o=c[0],h=c[1];if(j==""||o==j){h=h.replace(/[\w,]+:(.+)/,"$1");p.push(h);j=o;k.push(undefined)}else{var v=w(j,p.join(" "));p=[];p.push(h);j=o;k.push(v)}});k.push(w(j,p.join(" ")));k=k.join(" "+e+" ");return k='<span class="explanation">'+
n+" "+k+"</span>"};this.explain=y;var r=function(n,d){var e='<div class="header">';e+=y(d.type,d.combination);if(n.offset>0)e+='<div class="tothetop"><a href="#" onclick="javascript:$(\'body\').animate({scrollTop: 0}, 500);">&uarr;</a></div>';return e};this.render=function(n){n.allocations.each(function(d,e){if(e.entries.length>0){f.append(r(n,e)).append(e.entries.join(g));f.children("li").wrapAll(m)}});f.append(a.render(n))}};function AllocationRenderer(a,b){function i(d){var e={},j={},p=[],k;k=0;for(l=d.length;k<l;k++){var u=d[k][0];if(u in e){e[u]=e[u]+" "+d[k][1];p.push(k)}else{e[u]=d[k][1];j[k]=u}}for(k in j)d[k][1]=e[j[k]];for(k=p.length-1;k>=0;k--)d.remove(p[k]);return d}function f(d){return $.map(d,function(e,j){return"%"+(j+1)+"$s"}).join(" ")}function g(d){if(d.length==0)return"";var e=d=i(d);e.sort(function(v,z){return v[0]<z[0]?-1:1});for(var j=[],p=0,k=e.length;p<k;p++)j.push(e[p][0]);var u=j.length==1,c=r[j]||
(r[j]=f(j));if($.type(c)==="string"){r[j]={format:c};c=r[j]}var o=1,h=c.format;$.each(d,function(v,z){var A=z[0],B=z[2];if(c.filter)B=c.filter(B);A=w[A]||A;if(u&&!(c&&c.ignoreSingle))return h=B+"&nbsp;("+A+")";h=h.replace(RegExp("%"+o+"\\$s","g"),B);o+=1;return o});return h}function m(d){for(var e=[],j=0,p=y.length;j<p;j++)e.push([]);e.push([]);j=0;for(p=d.length;j<p;j++){for(var k=d[j],u=k[0],c=false,o=0,h=y.length;o<h;o++)if(y[o].include(u)){e[o].push(k);c=true;break}c||e[e.length-1].push(k)}var v;
for(d=e.length-1;d>=0;d--){v=e[d];if(v.length>0)break}v=v[v.length-1];n.include(v[0])||(v[1]+="...");return $.map(e,function(z){return g(z)})}function q(d){var e=[],j,p;for(p in d){j=d[p][0];j=x[j]||j;e[p]=j+":"+d[p][2]}return e.join(" ")}var s=b.locale,x=Localization.qualifiers&&Localization.qualifiers[s]||{},w=Localization.explanations&&Localization.explanations[s]||{},y=b.groups||[],r=Localization.choices&&Localization.choices[s]||{};this.explanation=this.query=this.text="";var n=["street_number",
"zipcode"];this.contract=i;this.rendered=g;this.groupify=m;this.querify=q;this.render=function(d){var e=d.combination,j=d.count;d=q(e);e=m(e).join(" ");e=$('<li><div class="text">'+e+'</div><div class="count">'+j+"</div></li>");e.bind("click",{query:d},a);return e}};var PickyAllocationsCloud=function(a,b){var i=b.allocations,f=b.shownAllocations,g=b.showMoreAllocations,m=b.hiddenAllocations,q=b.maxSuggestions,s=function(){i.hide()},x=new AllocationRenderer(function(r){s();a.allocationChosen(r)},b),w=function(r){var n=[];r.each(function(d,e){n.push(x.render(e))});return n},y=function(r){if(r.length==0)return i.hide();f.empty();g.hide();m.empty().hide();if(r.length>q){$.each(r.slice(0,q-1),function(n,d){f.append(d)});$.each(r.slice(q-1),function(n,d){m.append(d)});
g.show()}else $.each(r,function(n,d){f.append(d)});return i.show()};g.click(function(){g.hide();m.show()});this.hide=s;this.show=function(r){y(w(r.allocations));i.show()}};
