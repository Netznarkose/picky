Array.prototype.index=function(c){for(var i=0,g=this.length;i<g;i++)if(this[i]==c)return i;return null};Array.prototype.include=function(c){return this.index(c)!==null};Array.prototype.remove=function(c){this.splice(c,1);return this};var PickyI18n={};$(function(){PickyI18n.locale=$("html").attr("lang").split("-")[0]||"en"});
var dictionary={common:{join:{de:"und",fr:"et",it:"e",en:"and",ch:"und"},"with":{de:"mit",fr:"avec",it:"con",en:"with",ch:"mit"},of:{de:"von",fr:"de",it:"di",en:"of",ch:"vo"},to:{de:"bis",fr:"\u00e0",it:"alla",en:"to",ch:"bis"}},results:{addination:{more:{de:"Weitere Resultate",fr:"Autres r\u00e9sultats",it:"Altri risultati",en:"More results",ch:"Mee Resultaat"}},header:{de:"Ergebnisse",fr:"R\u00e9sultats",it:"Risultati",en:"Results",ch:"Erg\u00e4bnis"}}},t=function(c){for(var i=PickyI18n.locale||
"en",g=c.split(".").concat(i),e=dictionary,d=0,k=g.length;d<k;d++){e=e[g[d]];if(e==undefined){e="Translation missing: "+c+"."+i;break}}return e};function Allocation(c,i,g,e,d,k){var p=this;this.type=c;this.weight=i;this.count=g;this.combination=e;this.ids=d||[];this.entries=this.rendered=k||[];this.isType=function(s){return s==p.type}}function Allocations(c){this.allocations=[];for(var i=0,g=c.length;i<g;i++){var e=c[i];this.allocations.push(new Allocation(e[0],e[1],e[2],e[3],e[4],e[5]))}this.length=this.allocations.length;this.each=function(d){return $.each(this.allocations,d)}}
function PickyData(c){var i=c.total,g=c.duration,e=c.offset,d=new Allocations(c.allocations||[]);this.original_hash=c;this.total=i;this.duration=g;this.offset=e;this.allocations=d;this.isEmpty=function(){return i==0}};var PickyView=function(c,i){var g=i.showResultsLimit||10,e=$("#picky input.query"),d=$("#picky div.reset"),k=$("#picky input.search_button"),p=$("#picky div.status"),s=$("#picky .dashboard"),w=$("#picky .results"),j=$("#picky .no_results"),m=new PickyAddination(this,w),r=new PickyAllocationsCloud(this,i),o=new PickyResultsRenderer(m,i),a=function(){d.fadeTo(166,1)},b=function(){r.hide();w.empty();j.hide()},f=function(h){e.val(h);d.fadeTo(166,0);u("empty");p.empty();b()},n=function(){return e.val()};
this.text=n;var q=function(h){p.text(h);h>0&&h<=5&&p.fadeTo("fast",0.5).fadeTo("fast",1)},v=function(h){if(h.isEmpty())return"none";if(h.total>g&&h.allocations.length>1)return"support";return"ok"},u=function(h){s.attr("class","dashboard "+h)};this.insert=function(h){e.val(h);e.select()};this.fullResultsCallback=function(h){u(v(h));if(h.isEmpty()){b();q(0);j.show();a()}else if(h.total>g&&h.allocations.length>1){b();a();r.show(h);q(h.total)}else if(h.offset==0){b();q(h.total);o.render(h);w.show();a();
e.focus()}else{m.remove();o.render(h);$("body").animate({scrollTop:$("#picky div.results div.header:last").position().top-12},500)}};this.liveResultsCallback=function(h){u(v(h));q(h.total)};this.allocationChosen=function(h){h=h.data.query;e.val(h);c.allocationChosen(h)};this.addinationClicked=function(h){c.addinationClicked(n(),h)};(function(){e.keyup(function(h){if(n()==""){f();c.searchTextCleared()}else{c.searchTextEntered(n(),h);a()}});p.click(function(){n()==""||c.searchButtonClicked(n())});k.click(function(){n()==
""||c.searchButtonClicked(n())});d.click(function(){f("");c.clearButtonClicked();e.focus()})})();e.focus()};var PickyBackend=function(c){var i=function(g,e,d){var k=d||{};k=$.extend({query:g},d);$.getJSON(c,k,function(p){e&&e(new PickyData(p))})};this.search=function(g,e,d,k){i(g,function(p){e&&e(k,p)},d)}},LiveBackend=function(c){var i=new PickyBackend(c);this.search=function(g,e,d,k){k=k||{};latestRequestTimestamp=new Date;k.live=latestRequestTimestamp;d=$.extend({ids:0,offset:0},d);i.search(g,function(p,s){if(!p.live||p.live==latestRequestTimestamp)e&&e(s)},d,k)}},FullBackend=function(c){var i=new PickyBackend(c);
this.search=function(g,e,d,k){k=k||{};latestRequestTimestamp=new Date;k.full=latestRequestTimestamp;d=$.extend({ids:20,offset:0},d);i.search(g,function(p,s){if(!p.full||p.full==latestRequestTimestamp)e&&e(s)},d,k)}};var PickyController=function(c){var i=new PickyView(this,c),g=c.backends,e=c.before||function(){},d=c.success||function(){},k=c.after||function(){},p=function(a){return(a=a&&a.match(/q=([^&]+)/))&&unescape(a[1]||"")};this.extractQuery=p;var s=function(){var a=window.History&&window.History.getState();return p(a&&a.url)};this.lastQuery=s;var w=function(a,b){a=d(a,b)||a;i.liveResultsCallback(a);k(a,b)},j,m=function(){var a=i.text(),b={};b=e(b)||b;var f=g.live;f&&f.search(a,w,b);clearInterval(j)};j=
setInterval(m,180);clearInterval(j);var r=function(a,b){a=d(a,b)||a;i.fullResultsCallback(a);k(a,b)},o=function(a,b){var f=b||{};clearInterval(j);if(a!=s()){var n="?q="+escape(a).replace(/\*/g,"%2A");window.History&&window.History.getState()&&window.History.pushState&&window.History.pushState(null,null,n)}f=e(f,a)||f;(n=g.full)&&n.search(a,r,f)};this.insert=function(a,b){i.insert(a);b&&o(a)};this.clearButtonClicked=function(){clearInterval(j)};this.searchTextCleared=function(){clearInterval(j)};this.searchTextEntered=
function(a,b){if($.inArray(b.keyCode,[0,8,13,32,46,48,49,50,51,52,53,54,55,56,57,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90])>-1)if(b.keyCode==13)o(a);else{clearInterval(j);j=setInterval(m,180)}};this.searchButtonClicked=function(a){o(a)};this.allocationChosen=function(a){o(a)};this.addinationClicked=function(a,b){o(a,{offset:b.data.offset})}};var Localization={},PickyClient=function(c){Localization.qualifiers=c.qualifiers||{};Localization.explanations=c.explanations||{};Localization.choices=c.choices||{};Localization.explanation_delimiters={de:"und",fr:"et",it:"e",en:"and",ch:"und"};var i=c.backends;if(i){i.live||alert("Both a full and live backend must be provided.");i.full||alert("Both a full and live backend must be provided.")}else c.backends={live:c.live&&new LiveBackend(c.live)||alert("A live backend path must be provided."),full:c.full&&
new FullBackend(c.full)||alert("A live backend path must be provided.")};var g=c.controller&&new c.controller(c)||new PickyController(c);var e=this.insert=function(d,k){g.insert(d,k||true)};this.insertFromURL=function(d){if(d&&d!="")e(d);else(d=g.lastQuery())&&e(d)};window.History&&window.History.Adapter.bind(window,"statechange",function(){var d=window.History.getState();(d=g.extractQuery(d.url))&&e(d)})};var PickyAddination=function(c,i){this.remove=function(){i.find(".addination").remove()};this.render=function(g){var e=g.total,d;d=g.offset+20;var k=d+20;g=g.total;if(g<k)k=g;d={offset:d,start:d+1,end:k};if(d.offset<e){e=$("<div class='addination'>"+t("results.addination.more")+"</div>");e.bind("click",{offset:d.offset},c.addinationClicked);return e}else return""}};var PickyResultsRenderer=function(c,i){var g=i.wrapResults||'<ol class="results"></ol>',e=["street_number","zipcode"],d=function(j){var m=j[j.length-1];j=j.slice(0,j.length-1);if(j==[])j=[j];if(!e.include(m[0]))if(m[1].match(/[^\*~]$/))m[1]+="*";j.push(m);return j},k=function(j){for(var m=Localization.explanations&&Localization.explanations[PickyI18n.locale]||{},r=[],o,a=0,b=j.length;a<b;a++){o=j[a];var f=o[0];f=m[f]||f;r.push([f,o[1]])}return r},p=function(j,m){return[j.replace(/([\w\s\u00c4\u00e4\u00d6\u00f6\u00dc\u00fc\u00e9\u00e8\u00e0]+)/,
"<strong>$1</strong>"),m].join(" ")},s=function(j,m){var r=Localization.explanation_delimiters[PickyI18n.locale],o=k(d(m)),a="",b=[];o=$.map(o,function(f){var n=f[0];f=f[1];if(a==""||n==a){b.push(f);a=n}else{var q=p(a,b.join(" "));b=[];b.push(f);a=n;return q}});o.push(p(a,b.join(" ")));o=o.join(" "+r+" ");return'<span class="explanation">'+j+" "+o+"</span>"},w=function(j,m){var r='<div class="header">';r+=s(m.type,m.combination);if(j.offset>0)r+='<div class="tothetop"><a href="#" onclick="javascript:$(\'body\').animate({scrollTop: 0}, 500);">&uarr;</a></div>';
return r};this.render=function(j){var m=$("#picky div.results");j.allocations.each(function(r,o){m.append(w(j,o)).append(o.entries.join("")).append(c.render(j));m.children("li").wrapAll(g)})}};function AllocationRenderer(c,i){function g(a){var b={},f={},n=[],q;q=0;for(l=a.length;q<l;q++){var v=a[q][0];if(v in b){b[v]=b[v]+" "+a[q][1];n.push(q)}else{b[v]=a[q][1];f[q]=v}}for(q in f)a[q][1]=b[f[q]];for(q=n.length-1;q>=0;q--)a.remove(n[q]);return a}function e(a){return $.map(a,function(b,f){return"%"+(f+1)+"$s"}).join(" ")}function d(a){if(a.length==0)return"";var b=a=g(a);b.sort(function(x,y){return x[0]<y[0]?-1:1});for(var f=[],n=0,q=b.length;n<q;n++)f.push(b[n][0]);var v=f.length==1,u=r[f]||
(r[f]=e(f));if($.type(u)==="string"){r[f]={format:u};u=r[f]}var h=1,z=u.format;$.each(a,function(x,y){var A=y[0],B=y[1];if(u.filter)B=u.filter(B);A=j[A]||A;if(v&&!(u&&u.ignoreSingle))return z=B+"&nbsp;("+A+")";z=z.replace(RegExp("%"+h+"\\$s","g"),B);h+=1;return h});return z}function k(a){for(var b=[],f=0,n=m.length;f<n;f++)b.push([]);b.push([]);f=0;for(n=a.length;f<n;f++){for(var q=a[f],v=q[0],u=false,h=0,z=m.length;h<z;h++)if(m[h].include(v)){b[h].push(q);u=true;break}u||b[b.length-1].push(q)}var x;
for(a=b.length-1;a>=0;a--){x=b[a];if(x.length>0)break}x=x[x.length-1];o.include(x[0])||(x[1]+="...");return $.map(b,function(y){return d(y)})}function p(a){var b=[],f,n;for(n in a){f=a[n][0];f=w[f]||f;b[n]=f+":"+a[n][1]}return b.join(" ")}var s=PickyI18n.locale,w=Localization.qualifiers&&Localization.qualifiers[s]||{},j=Localization.explanations&&Localization.explanations[s]||{},m=i.groups||[],r=Localization.choices&&Localization.choices[s]||{};this.explanation=this.query=this.text="";var o=["street_number",
"zipcode"];this.contract=g;this.rendered=d;this.groupify=k;this.querify=p;this.render=function(a){var b=a.combination,f=a.count;a=p(b);b=k(b).join(" ");b=$('<li><div class="text">'+b+'</div><div class="count">'+f+"</div></li>");b.bind("click",{query:a},c);return b}};var PickyAllocationsCloud=function(c,i){var g=$("#picky .allocations"),e=g.find(".shown"),d=g.find(".more"),k=g.find(".hidden"),p=function(){g.hide()},s=new AllocationRenderer(function(m){p();c.allocationChosen(m)},i),w=function(m){var r=[];m.each(function(o,a){r.push(s.render(a))});return r},j=function(m){if(m.length==0)return $("#search .allocations").hide();e.empty();d.hide();k.empty().hide();if(m.length>3){$.each(m.slice(0,2),function(r,o){e.append(o)});$.each(m.slice(2),function(r,o){k.append(o)});
d.show()}else $.each(m,function(r,o){e.append(o)});return $("#search .allocations").show()};d.click(function(){d.hide();k.show()});this.hide=p;this.show=function(m){j(w(m.allocations));g.show()}};
