Array.prototype.index=function(a){for(var b=0,i=this.length;b<i;b++)if(this[b]==a)return b;return null};Array.prototype.include=function(a){return this.index(a)!==null};Array.prototype.remove=function(a){this.splice(a,1);return this};Array.prototype.compare=function(a){return this.join("")==a.join("")};Array.prototype.each=function(a){for(var b=0,i=this.length;b<i;b++)a(b,this[b]);return this};var dictionary={common:{join:{de:"und",fr:"et",it:"e",en:"and",ch:"und"},"with":{de:"mit",fr:"avec",it:"con",en:"with",ch:"mit"},of:{de:"von",fr:"de",it:"di",en:"of",ch:"vo"},to:{de:"bis",fr:"\u00e0",it:"alla",en:"to",ch:"bis"}},results:{addination:{more:{de:"Weitere Resultate",fr:"Autres r\u00e9sultats",it:"Altri risultati",en:"More results",ch:"Mee Resultaat"}},header:{de:"Ergebnisse",fr:"R\u00e9sultats",it:"Risultati",en:"Results",ch:"Erg\u00e4bnis"}}},t=function(a){for(var b=PickyI18n.locale||
"en",i=a.split(".").concat(b),f=dictionary,e=0,k=i.length;e<k;e++){f=f[i[e]];if(f==undefined){f="Translation missing: "+a+"."+b;break}}return f};function Allocation(a,b,i,f,e,k){var q=this;this.type=a;this.weight=b;this.count=i;this.combination=f;this.ids=e||[];this.entries=this.rendered=k||[];this.isType=function(s){return s==q.type}}function Allocations(a){this.allocations=[];for(var b=0,i=a.length;b<i;b++){var f=a[b];this.allocations.push(new Allocation(f[0],f[1],f[2],f[3],f[4],f[5]))}this.length=this.allocations.length;this.remove=function(e){this.allocations.splice(e,1)};this.each=function(e){this.allocations.each(e)}}
function PickyData(a){var b=a.total,i=a.duration,f=a.offset,e=new Allocations(a.allocations||[]);this.original_hash=a;this.total=b;this.duration=i;this.offset=f;this.allocations=e;this.renderedAmount=function(){var k=0;e.each(function(q,s){k+=s.rendered.length});return k};this.isEmpty=function(){return b==0}};var PickyView=function(a,b){var i=b.showResultsLimit||10,f=b.input,e=b.reset,k=b.button,q=b.counter,s=b.dashboard,x=b.moreSelector,v=b.results,y=b.noResults,r=new PickyAddination(this,v),p=new PickyAllocationsCloud(this,b),g=new PickyResultsRenderer(r,b),d=function(){e.fadeTo(166,1)},j=function(){p.hide();v.empty();y.hide()},m=function(h){f.val(h);e.fadeTo(166,0);o("empty");q.empty();j()},n=function(){return f.val()};this.text=n;var u=function(h){q.text(h);h>0&&h<=5&&q.fadeTo("fast",0.5).fadeTo("fast",
1)},c=function(h){if(h.isEmpty())return"none";if(h.total>i&&h.allocations.length>1)return"support";return"ok"},o=function(h){s.attr("class","dashboard "+h)};this.insert=function(h){f.val(h);f.select()};this.fullResultsCallback=function(h){o(c(h));if(h.isEmpty()){j();u(0);y.show();d()}else if(h.total>i&&h.allocations.length>1){j();d();p.show(h);u(h.total)}else if(h.offset==0){j();u(h.total);g.render(v,h);v.show();d();f.focus()}else{var w=$(x).position().top;r.remove();g.render(v,h);$("body").animate({scrollTop:w-
12},500)}};this.liveResultsCallback=function(h){o(c(h));u(h.total)};this.allocationChosen=function(h){h=h.data.query;a.insert(h);a.allocationChosen(h)};this.addinationClicked=function(h){a.addinationClicked(n(),h)};(function(){f.keyup(function(h){if(n()==""){m();a.searchTextCleared()}else{a.searchTextEntered(n(),h);d()}});q.click(function(){n()==""||a.searchButtonClicked(n())});k.click(function(){n()==""||a.searchButtonClicked(n())});e.click(function(){m("");a.clearButtonClicked();f.focus()})})();
f.focus()};var PickyBackend=function(a){var b=function(i,f,e){var k=e||{};k=$.extend({query:i},e);$.getJSON(a,k,function(q){f&&f(new PickyData(q))})};this.search=function(i,f,e,k){b(i,function(q){f&&f(k,q)},e)}},LiveBackend=function(a){var b=a.live||alert("A live backend path must be provided."),i=new PickyBackend(b);this.search=function(f,e,k,q){q=q||{};latestRequestTimestamp=new Date;q.live=latestRequestTimestamp;k=$.extend({ids:a.liveResults||0,offset:0},k);i.search(f,function(s,x){if(!s.live||s.live==latestRequestTimestamp)e&&
e(x)},k,q)}},FullBackend=function(a){var b=a.full||alert("A full backend path must be provided."),i=new PickyBackend(b);this.search=function(f,e,k,q){q=q||{};latestRequestTimestamp=new Date;q.full=latestRequestTimestamp;k=$.extend({ids:a.fullResults||20,offset:0},k);i.search(f,function(s,x){if(!s.full||s.full==latestRequestTimestamp)e&&e(x)},k,q)}};var PickyController=function(a){var b=new PickyView(this,a),i=a.backends,f=a.beforeInsert||function(){},e=a.before||function(){},k=a.success||function(){},q=a.after||function(){},s=a.liveRendered||false,x=a.liveSearchInterval||180,v,y=function(c){return(c=c&&c.match(/q=([^&]+)/))&&decodeURIComponent(c[1]).replace(/\+/g," ").replace(/#/g,"")||""};this.extractQuery=y;var r=function(){var c=window.History&&window.History.getState();return y(c&&c.url)};this.lastFullQuery=r;var p=function(c,o,h,w){o=e(o,
w)||o;v=[c,o,h,w];var z=o;if(z!=r()){z="?q="+escape(z).replace(/\*/g,"%2A");window.History&&window.History.getState()&&window.History.pushState&&window.History.pushState(null,null,z)}(c=i[c])&&c.search(o,h,w)};this.resend=function(){v&&p.apply(this,v)};var g=function(c,o){c=k(c,o)||c;b.fullResultsCallback(c);q(c,o)},d=function(c,o){clearInterval(m);p("full",c,g,o||{})};a=function(c,o){c=k(c,o)||c;b.liveResultsCallback(c);q(c,o)};var j=s?g:a,m,n=function(){var c=b.text();p("live",c,j,{});clearInterval(m)};
m=setInterval(n,x);clearInterval(m);var u=function(c,o,h){c=f(c)||c;b.insert(c);h&&d(c,o)};this.insert=u;this.clearButtonClicked=function(){clearInterval(m)};this.searchTextCleared=function(){clearInterval(m)};this.searchTextEntered=function(c,o){if($.inArray(o.keyCode,[0,8,13,32,46,48,49,50,51,52,53,54,55,56,57,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90])>-1)if(o.keyCode==13)d(c);else{clearInterval(m);m=setInterval(n,x)}};this.searchButtonClicked=function(c){d(c)};
this.allocationChosen=function(c){d(c)};this.addinationClicked=function(c,o){d(c,{offset:o.data.offset})};window.History&&window.History.Adapter.bind(window,"statechange",function(){var c=window.History.getState();(c=y(c.url))&&c!=(v.length>1&&v[1])&&u(c,{},true)})};var PickyI18n={},PickyClient=function(a){PickyI18n.locale=$("html").attr("lang").split("-")[0]||"en";a.locale=a.locale||PickyI18n.locale;a.qualifiers=a.qualifiers||{};a.explanations=a.explanations||{};a.choices=a.choices||{};a.explanation_delimiters={ch:"und",de:"und",en:"and",fr:"et",it:"e"};var b=a.backends;if(b){b.live||alert("Both a full and live backend must be provided.");b.full||alert("Both a full and live backend must be provided.")}else a.backends={live:new LiveBackend(a),full:new FullBackend(a)};
b=a.enclosingSelector||"#picky";a.input=$(a.inputSelector||b+" input.query");a.reset=$(a.resetSelector||b+" div.reset");a.button=$(a.buttonSelector||b+" input.search_button");a.counter=$(a.counterSelector||b+" div.status");a.dashboard=$(a.dashboardSelector||b+" .dashboard");a.results=$(a.resultsSelector||b+" div.results");a.noResults=$(a.noResultsSelector||b+" .no_results");a.moreSelector=a.moreSelector||b+" div.results div.addination:last";a.allocations=$(a.allocationsSelector||b+" .allocations");
a.shownAllocations=a.allocations.find(".shown");a.showMoreAllocations=a.allocations.find(".more");a.hiddenAllocations=a.allocations.find(".hidden");a.maxSuggestions=a.maxSuggestions||3;a.results=$(a.resultsSelector||b+" div.results");a.resultsDivider=a.resultsDivider||"";a.nonPartial=a.nonPartial||[];a.wrapResults=a.wrapResults||'<ol class="results"></ol>';var i=a.controller&&new a.controller(a)||new PickyController(a);var f=this.insert=function(e,k,q){i.insert(e,k||{},q||true)};this.resend=i.resend;
this.insertFromURL=function(e){if(e&&e!="")f(e);else(e=i.lastFullQuery())&&f(e)}};var PickyAddination=function(a,b){this.remove=function(){b.find(".addination").remove()};this.render=function(i){var f=i.total,e,k=i.renderedAmount();e=i.offset+k;k=e+k;i=i.total;if(i<k)k=i;e={offset:e,start:e+1,end:k};if(e.offset<f){f=$("<div class='addination'>"+t("results.addination.more")+"</div>");f.bind("click",{offset:e.offset},a.addinationClicked);return f}else return""}};var PickyResultsRenderer=function(a,b){var i=b.locale,f=b.resultsDivider,e=b.wrapResults,k=b.nonPartial,q=function(r){var p=r[r.length-1];if(p===undefined)return[];r=r.slice(0,r.length-1);if(r==[])r=[r];if(!k.include(p[0]))if(p[1].match(/[^\*~]$/))p[1]+="*";r.push(p);return r};this.asteriskifyLastToken=q;var s=function(r){for(var p=Localization.explanations&&Localization.explanations[i]||{},g=[],d,j=0,m=r.length;j<m;j++){d=r[j];var n=d[0];n=p[n]||n;g.push([n,d[1]])}return g};this.explainCategory=
s;var x=function(r,p){return[r.replace(/([\w\s\u00c4\u00e4\u00d6\u00f6\u00dc\u00fc\u00e9\u00e8\u00e0\,]+)/,"<strong>$1</strong>"),p].join(" ")};this.strongify=x;var v=function(r,p){var g=Localization.explanation_delimiters[i],d="",j=[],m=[];s(q(p)).each(function(n,u){var c=u[0],o=u[1];if(d==""||c==d){o=o.replace(/[\w,]+:(.+)/,"$1");j.push(o);d=c}else{var h=x(d,j.join(" "));j=[];j.push(o);d=c;m.push(h)}});m.push(x(d,j.join(" ")));m=m.join(" "+g+" ");return m='<span class="explanation">'+r+" "+m+"</span>"};
this.explain=v;var y=function(r,p){var g='<div class="header">';g+=v(p.type,p.combination);if(r.offset>0)g+='<div class="tothetop"><a href="#" onclick="javascript:$(\'body\').animate({scrollTop: 0}, 500);">&uarr;</a></div>';g+="</div>";return g};this.renderHeader=y;this.render=function(r,p){p.allocations.each(function(g,d){if(d.entries.length>0){r.append(y(p,d)).append(d.entries.join(f));r.children("li").wrapAll(e)}});r.append(a.render(p))}};function AllocationRenderer(a,b){function i(g){var d={},j={},m=[],n;n=0;for(l=g.length;n<l;n++){var u=g[n][0];if(u in d){d[u]=d[u]+" "+g[n][1];m.push(n)}else{d[u]=g[n][1];j[n]=u}}for(n in j)g[n][1]=d[j[n]];for(n=m.length-1;n>=0;n--)g.remove(m[n]);return g}function f(g){var d=[];g.each(function(j){d.push("%"+(j+1)+"$s")});return d.join(" ")}function e(g){if(g.length==0)return"";var d=g=i(g);d.sort(function(h,w){return h[0]<w[0]?-1:1});for(var j=[],m=0,n=d.length;m<n;m++)j.push(d[m][0]);var u=j.length==
1,c=r[j.join(",")]||(r[j]=f(j));if(typeof c==="string"){r[j]={format:c};c=r[j]}var o=c.format;g.each(function(h,w){var z=w[0],A=w[2];if(c.filter)A=c.filter(A);z=v[z]||z;if(u&&!(c&&c.ignoreSingle))return o=A+"&nbsp;("+z+")";o=o.replace(RegExp("%"+(h+1)+"\\$s","g"),A)});return o}function k(g){for(var d=[],j=0,m=y.length;j<m;j++)d.push([]);d.push([]);j=0;for(m=g.length;j<m;j++){for(var n=g[j],u=n[0],c=false,o=0,h=y.length;o<h;o++)if(y[o].include(u)){d[o].push(n);c=true;break}c||d[d.length-1].push(n)}var w;
for(g=d.length-1;g>=0;g--){w=d[g];if(w.length>0)break}w=w[w.length-1];p.include(w[0])||(w[1]+="...");var z=[];d.each(function(A,B){z.push(e(B))});return z}function q(g){return k(g).join(" ")}var s=b.locale,x=b.qualifiers&&b.qualifiers[s]||{},v=b.explanations&&b.explanations[s]||{},y=b.groups||[],r=b.choices&&b.choices[s]||{},p=b.nonPartial||[];this.explanation=this.query=this.text="";this.contract=i;this.makeUpMissingFormat=f;this.rendered=e;this.groupify=k;this.querify=function(g){var d=[],j,m;for(m in g){j=
g[m][0];j=x[j]||j;d[m]=j+":"+g[m][2]}return d.join(" ")};this.suggestify=q;this.render=function(g){return q(g.combination)}};var PickyAllocationsCloud=function(a,b){var i=b.allocations,f=b.shownAllocations,e=b.showMoreAllocations,k=b.hiddenAllocations,q=b.maxSuggestions,s=function(){i.hide()},x=function(p){s();a.allocationChosen(p)},v=new AllocationRenderer(b),y=function(p){var g=[];p.each(function(d,j){var m=v.render(j),n=v.querify(j.combination);m=$('<li><div class="text">'+m+'</div><div class="count">'+j.count+"</div></li>");m.bind("click",{query:n},x);g.push(m)});return g},r=function(p){if(p.length==0)return i.hide();
f.empty();e.hide();k.empty().hide();if(p.length>q){$.each(p.slice(0,q-1),function(g,d){f.append(d)});$.each(p.slice(q-1),function(g,d){k.append(d)});e.show()}else $.each(p,function(g,d){f.append(d)});return i.show()};e.click(function(){e.hide();k.show()});this.hide=s;this.show=function(p){r(y(p.allocations));i.show()}};
